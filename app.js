const qs=(s,r=document)=>r.querySelector(s);const editor=qs('#editor');const fileInput=qs('#fileInput');const imgInput=qs('#imgInput');const pasteBtn=qs('#pasteBtn');const insertImageBtn=qs('#insertImageBtn');const preview=qs('#preview');const columnsSel=qs('#columns');const fontFamilySel=qs('#fontFamily');const baseSizeInput=qs('#baseSize');const templateSelect=qs('#templateSelect');const applyTemplateBtn=qs('#applyTemplate');const pageSizeSel=qs('#pageSize');const adminToggle=qs('#adminToggle');const adminPanel=qs('#adminPanel');const importTemplatesBtn=qs('#importTemplates');const exportTemplatesBtn=qs('#exportTemplates');const resetTemplatesBtn=qs('#resetTemplates');const newTemplateBtn=qs('#newTemplate');const saveTemplateBtn=qs('#saveTemplate');const deleteTemplateBtn=qs('#deleteTemplate');const aiSuggestBtn=qs('#aiSuggest');const tplKey=qs('#tplKey');const tplName=qs('#tplName');const tplColumns=qs('#tplColumns');const tplFont=qs('#tplFont');const tplBase=qs('#tplBase');const tplPage=qs('#tplPage');const tplMargins=qs('#tplMargins');const tplHeadings=qs('#tplHeadings');const tplFigure=qs('#tplFigure');let defaultTemplates={};let templates={};async function loadDefaultTemplates(){const r=await fetch('./templates/templates.json');defaultTemplates=await r.json()}function loadLocalTemplates(){const raw=localStorage.getItem('sjf.templates');templates=raw?JSON.parse(raw):structuredClone(defaultTemplates)}function saveLocalTemplates(){localStorage.setItem('sjf.templates',JSON.stringify(templates))}function refreshTemplateSelect(){templateSelect.innerHTML='';Object.keys(templates).forEach(key=>{const opt=document.createElement('option');opt.value=key;opt.textContent=templates[key].displayName||key;templateSelect.appendChild(opt)})}function initPreviewDoc(){const doc=preview.contentDocument;doc.open();doc.write(`<!doctype html><html><head><meta charset=\"utf-8\"><link rel=\"stylesheet\" href=\"./styles.css\"><style id=\"tplStyle\"></style></head><body><article id=\"doc\" class=\"preview-doc\" style=\"column-count:2;\"></article></body></html>`);doc.close()}initPreviewDoc();function applyHeadingStyles(tpl){const doc=preview.contentDocument;const style=doc.getElementById('tplStyle');let css='';const h=tpl.headings||{};if(h.h1)css+=`.preview-doc h1{font-size:${h.h1.size||'1.6em'};font-weight:${h.h1.weight||700};margin:${h.h1.margin||'0.8em 0 0.4em'};}`;if(h.h2)css+=`.preview-doc h2{font-size:${h.h2.size||'1.3em'};font-weight:${h.h2.weight||600};margin:${h.h2.margin||'0.7em 0 0.35em'};}`;if(h.h3)css+=`.preview-doc h3{font-size:${h.h3.size||'1.15em'};font-weight:${h.h3.weight||600};margin:${h.h3.margin||'0.6em 0 0.3em'};}`;const fig=tpl.figure||{};if(fig.captionSize||fig.captionColor){css+=`.figure figcaption{${fig.captionSize?`font-size:${fig.captionSize};`:''}${fig.captionColor?`color:${fig.captionColor};`:''}}`}style.textContent=css}function setPreviewVars({columns,fontFamily,baseSize,pageSize,margins}){const doc=preview.contentDocument;const el=doc.getElementById('doc');if(columns)el.style.columnCount=String(columns);if(fontFamily)el.style.setProperty('--font-family',fontFamily);if(baseSize)el.style.setProperty('--base-size',baseSize+'px');const style=doc.getElementById('tplStyle');const mm=margins&&Array.isArray(margins)&&margins.length===4?`${margins[0]}mm ${margins[1]}mm ${margins[2]}mm ${margins[3]}mm`:'18mm';style.textContent+=`@media print{@page{size:${pageSize||'A4'};margin:${mm};}}`}function renderMarkdown(md){const html=marked.parse(md??'');const doc=preview.contentDocument;const host=doc.getElementById('doc');host.innerHTML=html;host.querySelectorAll('img').forEach(img=>{const fig=doc.createElement('figure');fig.className='figure';img.replaceWith(fig);fig.appendChild(img);const cap=doc.createElement('figcaption');cap.textContent=img.getAttribute('alt')||'Figura';fig.appendChild(cap)})}function updatePreview(){renderMarkdown(editor.value);setPreviewVars({columns:Number(columnsSel.value),fontFamily:fontFamilySel.value,baseSize:Number(baseSizeInput.value),pageSize:pageSizeSel.value})}editor.addEventListener('input',updatePreview);columnsSel.addEventListener('change',updatePreview);fontFamilySel.addEventListener('change',updatePreview);baseSizeInput.addEventListener('change',updatePreview);pageSizeSel.addEventListener('change',updatePreview);fileInput.addEventListener('change',async e=>{const file=e.target.files?.[0];if(!file)return;const type=(file.name||'').toLowerCase();if(type.endsWith('.docx')){alert('Lectura de .docx pendiente. Usa .md/.txt/.rtf.');return}const text=await file.text();editor.value=text;updatePreview()});pasteBtn.addEventListener('click',async()=>{try{const text=await navigator.clipboard.readText();editor.value=text;updatePreview()}catch{alert('No se pudo leer del portapapeles.')}});function surround(prefix,suffix=''){const start=editor.selectionStart;const end=editor.selectionEnd;const val=editor.value;const selected=val.slice(start,end);const before=val.slice(0,start);const after=val.slice(end);editor.value=before+prefix+selected+(suffix||prefix)+after;editor.focus();editor.selectionStart=start+prefix.length;editor.selectionEnd=end+prefix.length;updatePreview()}document.getElementById('h1Btn').addEventListener('click',()=>surround('\n\n# ',''));document.getElementById('h2Btn').addEventListener('click',()=>surround('\n\n## ',''));document.getElementById('boldBtn').addEventListener('click',()=>surround('**'));document.getElementById('italicBtn').addEventListener('click',()=>surround('*'));let imageUrls=[];imgInput.addEventListener('change',e=>{const files=Array.from(e.target.files||[]);files.forEach(f=>imageUrls.push({name:f.name,url:URL.createObjectURL(f)}));alert('Imágenes cargadas: '+files.map(f=>f.name).join(', '))});insertImageBtn.addEventListener('click',()=>{if(!imageUrls.length)return alert('Primero sube imágenes.');const names=imageUrls.map((x,i)=>`${i+1}) ${x.name}`).join('\n');const pick=prompt('Elige imagen (número):\n'+names);const idx=Number(pick)-1;if(Number.isNaN(idx)||!imageUrls[idx])return;const chosen=imageUrls[idx];surround(`\n\n![Figura](${chosen.url})\n\n`,'')});applyTemplateBtn.addEventListener('click',()=>{const key=templateSelect.value;const tpl=templates[key];if(!tpl)return;baseSizeInput.value=tpl.baseSizePx??12;fontFamilySel.value=tpl.fontFamily??fontFamilySel.value;columnsSel.value=String(tpl.columns??columnsSel.value);pageSizeSel.value=tpl.pageSize??'A4';applyHeadingStyles(tpl);setPreviewVars({columns:Number(columnsSel.value),fontFamily:fontFamilySel.value,baseSize:Number(baseSizeInput.value),pageSize:pageSizeSel.value,margins:tpl.marginsMm||[18,18,18,18],});updatePreview()});adminToggle.addEventListener('change',()=>{adminPanel.classList.toggle('hidden',!adminToggle.checked)});function fillEditorFromKey(key){const t=templates[key];if(!t)return;tplKey.value=key;tplName.value=t.displayName||'';tplColumns.value=t.columns??2;tplFont.value=t.fontFamily||'Inter, system-ui, sans-serif';tplBase.value=t.baseSizePx??12;tplPage.value=t.pageSize||'A4';tplMargins.value=(t.marginsMm||[18,18,18,18]).join(',');tplHeadings.value=JSON.stringify(t.headings||{},null,2);tplFigure.value=JSON.stringify(t.figure||{},null,2)}templateSelect.addEventListener('change',()=>{if(adminToggle.checked)fillEditorFromKey(templateSelect.value)});newTemplateBtn.addEventListener('click',()=>{tplKey.value='';tplName.value='';tplColumns.value=2;tplFont.value='Inter, system-ui, sans-serif';tplBase.value=12;tplPage.value='A4';tplMargins.value='18,18,18,18';tplHeadings.value='{"h1":{"size":"1.6em","weight":700},"h2":{"size":"1.3em","weight":600},"h3":{"size":"1.15em","weight":600}}';tplFigure.value='{"captionSize":"0.9em","captionColor":"#555","span":"auto"}'});saveTemplateBtn.addEventListener('click',()=>{const key=(tplKey.value||'').trim();if(!key)return alert('La clave de plantilla es obligatoria.');let headings={};let figure={};try{headings=tplHeadings.value?JSON.parse(tplHeadings.value):{}}catch{return alert('Headings JSON inválido')}try{figure=tplFigure.value?JSON.parse(tplFigure.value):{}}catch{return alert('Figure JSON inválido')}const margins=(tplMargins.value||'18,18,18,18').split(',').map(x=>Number(x.trim()));templates[key]={displayName:tplName.value||key,columns:Number(tplColumns.value),fontFamily:tplFont.value,baseSizePx:Number(tplBase.value),pageSize:tplPage.value,marginsMm:margins.length===4?margins:[18,18,18,18],headings,figure};saveLocalTemplates();refreshTemplateSelect();templateSelect.value=key;alert('Plantilla guardada.')});deleteTemplateBtn.addEventListener('click',()=>{const key=templateSelect.value;if(!key)return;if(!confirm('¿Eliminar plantilla "'+key+'"?'))return;delete templates[key];saveLocalTemplates();refreshTemplateSelect();newTemplateBtn.click()});importTemplatesBtn.addEventListener('click',async()=>{const input=document.createElement('input');input.type='file';input.accept='application/json';input.onchange=async()=>{const file=input.files?.[0];if(!file)return;try{const j=JSON.parse(await file.text());templates=j;saveLocalTemplates();refreshTemplateSelect();alert('Plantillas importadas.')}catch{alert('JSON inválido.')}};input.click()});exportTemplatesBtn.addEventListener('click',()=>{const blob=new Blob([JSON.stringify(templates,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='templates.json';a.click();URL.revokeObjectURL(a.href)});resetTemplatesBtn.addEventListener('click',()=>{if(!confirm('Restaurar plantillas por defecto?'))return;templates=structuredClone(defaultTemplates);saveLocalTemplates();refreshTemplateSelect();alert('Restaurado.')});if('serviceWorker'in navigator){navigator.serviceWorker.register('./sw.js')}window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();const btn=document.getElementById('installBtn');btn.classList.remove('hidden');btn.onclick=()=>e.prompt()});async function init(){await loadDefaultTemplates();loadLocalTemplates();refreshTemplateSelect();const firstKey=Object.keys(templates)[0];if(firstKey)templateSelect.value=firstKey;initPreviewDoc();editor.value=`# Título del artículo\n\n**Autores:** A. Pérez, B. García\n\n**Resumen:** Texto breve del resumen...\n\n## Introducción\nEscribe aquí...\n\n## Métodos\n...\n\n## Resultados\n...\n\n## Discusión\n...\n`;const tpl=templates[firstKey];if(tpl){applyHeadingStyles(tpl)}renderMarkdown(editor.value);setPreviewVars({columns:Number(columnsSel.value),fontFamily:fontFamilySel.value,baseSize:Number(baseSizeInput.value),pageSize:pageSizeSel.value})}init();